{% extends "base.html" %}

{% block title %}Playlists - Digital Signage Manager{% endblock %}

{% block content %}
<div class="playlist-page-layout">
    <!-- Sidebar with playlist list -->
    <div class="playlist-sidebar">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 style="margin: 0;">Playlists</h2>
            <button class="btn btn-primary" onclick="showCreatePlaylistModal()" style="padding: 0.4rem 0.8rem; font-size: 0.9rem;">+ New</button>
        </div>

        <div class="playlist-list">
            {% if playlists %}
                {% for playlist in playlists %}
                <div class="playlist-list-item" data-playlist-id="{{ playlist.id }}" onclick="selectPlaylist({{ playlist.id }})">
                    <div class="playlist-list-title">{{ playlist.name }}</div>
                    <div class="playlist-list-meta">
                        <span>{{ playlist.items|length }} items</span>
                        <button class="playlist-list-delete" onclick="event.stopPropagation(); deletePlaylist({{ playlist.id }}, '{{ playlist.name }}')">ğŸ—‘ï¸</button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div style="text-align: center; padding: 2rem; color: #999; font-size: 0.875rem;">
                    No playlists yet.<br>Click "+ New" to create one.
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Main content area -->
    <div class="playlist-main-content">
        <!-- Empty state -->
        <div id="emptyState" class="empty-state">
            <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“‹</div>
            <h3 style="color: #666; font-weight: 500;">Select a playlist to edit</h3>
            <p style="color: #999; font-size: 0.875rem;">Choose a playlist from the sidebar or create a new one</p>
        </div>

        <!-- Playlist Builder (shown when playlist selected) -->
        <div id="playlistBuilderSection" style="display: none;">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <h3 id="playlistName" style="margin-bottom: 0.25rem;"></h3>
                        <p id="playlistDescription" style="color: #666; margin: 0;"></p>
                    </div>
                    <button class="btn btn-success" onclick="savePlaylist()">Save Playlist</button>
                </div>
            </div>

            <div class="playlist-layout">
                <!-- Content Library -->
                <div class="content-library">
                    <h3>Content Library</h3>
                    <p style="color: #666; font-size: 0.875rem;">Drag content items to the playlist</p>
                    <div class="content-grid" id="contentGrid">
                        {% for content in content_list %}
                        <div class="content-item" draggable="true" data-content-id="{{ content.id }}" data-content='{{ content.to_dict()|tojson }}'>
                            <div class="content-thumbnail">
                                {% if content.content_type == 'image' %}
                                <img src="/api/content/{{ content.id }}/thumbnail" alt="{{ content.name }}" loading="lazy">
                                {% elif content.content_type == 'video' %}
                                ğŸ¬
                                {% else %}
                                ğŸ“„
                                {% endif %}
                            </div>
                            <div class="content-name" title="{{ content.name }}">{{ content.name }}</div>
                            <div class="content-meta">{{ content.content_type|capitalize }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Playlist Builder -->
                <div class="playlist-builder">
                    <h3>Playlist Items</h3>
                    <p style="color: #666; font-size: 0.875rem;">Drag to reorder, set duration for each item</p>
                    <div class="playlist-drop-zone empty" id="playlistDropZone">
                        <div id="emptyMessage">Drag content here to build your playlist</div>
                        <div id="playlistItems"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Playlist Modal -->
<div id="createPlaylistModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 500px; width: 90%;">
        <h2>Create New Playlist</h2>
        <div class="form-group">
            <label for="newPlaylistName">Playlist Name</label>
            <input type="text" id="newPlaylistName" required>
        </div>
        <div class="form-group">
            <label for="newPlaylistDescription">Description</label>
            <textarea id="newPlaylistDescription" rows="3"></textarea>
        </div>
        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
            <button class="btn btn-primary" onclick="createPlaylist()">Create</button>
            <button class="btn" onclick="hideCreatePlaylistModal()" style="background: #ccc;">Cancel</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let currentPlaylist = null;
    let playlistItems = [];
    let draggedElement = null;

    function selectPlaylist(playlistId) {
        // Remove selected class from all items
        document.querySelectorAll('.playlist-list-item').forEach(item => {
            item.classList.remove('selected');
        });

        // Add selected class to clicked item
        document.querySelector(`[data-playlist-id="${playlistId}"]`).classList.add('selected');

        // Load playlist
        loadPlaylist(playlistId);
    }

    async function loadPlaylist(playlistId) {
        try {
            const response = await fetch(`/api/playlist/${playlistId}`);
            if (!response.ok) {
                throw new Error('Failed to load playlist');
            }

            currentPlaylist = await response.json();
            displayPlaylist();
        } catch (error) {
            console.error('Error loading playlist:', error);
            alert('Failed to load playlist');
        }
    }

    function displayPlaylist() {
        // Hide empty state, show builder section
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('playlistBuilderSection').style.display = 'block';

        // Set header
        document.getElementById('playlistName').textContent = currentPlaylist.name;
        document.getElementById('playlistDescription').textContent = currentPlaylist.description || '';

        // Load items
        playlistItems = currentPlaylist.items || [];
        renderPlaylistItems();
    }

    function renderPlaylistItems() {
        const container = document.getElementById('playlistItems');
        const dropZone = document.getElementById('playlistDropZone');
        const emptyMessage = document.getElementById('emptyMessage');

        container.innerHTML = '';

        if (playlistItems.length === 0) {
            dropZone.classList.add('empty');
            emptyMessage.style.display = 'block';
        } else {
            dropZone.classList.remove('empty');
            emptyMessage.style.display = 'none';

            playlistItems.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'playlist-item';
                itemDiv.draggable = true;
                itemDiv.dataset.index = index;

                let thumbnail = '';
                if (item.content.content_type === 'image') {
                    thumbnail = `<img src="/api/content/${item.content.id}/thumbnail" alt="${item.content.name}">`;
                } else if (item.content.content_type === 'video') {
                    thumbnail = 'ğŸ¬';
                } else {
                    thumbnail = 'ğŸ“„';
                }

                itemDiv.innerHTML = `
                    <div class="playlist-item-thumbnail">${thumbnail}</div>
                    <div class="playlist-item-info">
                        <div class="playlist-item-name">${item.content.name}</div>
                        <div style="font-size: 0.875rem; color: #666;">${item.content.content_type}</div>
                    </div>
                    <div class="playlist-item-controls">
                        <input type="number" class="duration-input" value="${item.duration}" min="1"
                               onchange="updateItemDuration(${index}, this.value)">
                        <span style="font-size: 0.875rem; color: #666;">sec</span>
                        <button class="btn-icon" onclick="removePlaylistItem(${index})" title="Remove">ğŸ—‘ï¸</button>
                    </div>
                `;

                // Drag events for reordering
                itemDiv.addEventListener('dragstart', handlePlaylistItemDragStart);
                itemDiv.addEventListener('dragover', handlePlaylistItemDragOver);
                itemDiv.addEventListener('drop', handlePlaylistItemDrop);
                itemDiv.addEventListener('dragend', handlePlaylistItemDragEnd);

                container.appendChild(itemDiv);
            });
        }
    }

    // Content library drag events
    document.querySelectorAll('.content-item').forEach(item => {
        item.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('content', item.dataset.content);
            item.classList.add('dragging');
        });

        item.addEventListener('dragend', (e) => {
            item.classList.remove('dragging');
        });
    });

    // Drop zone events
    const dropZone = document.getElementById('playlistDropZone');

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', (e) => {
        if (e.target === dropZone) {
            dropZone.classList.remove('drag-over');
        }
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');

        const contentData = e.dataTransfer.getData('content');
        if (contentData) {
            const content = JSON.parse(contentData);
            addContentToPlaylist(content);
        }
    });

    function addContentToPlaylist(content) {
        // Check if already in playlist
        const exists = playlistItems.find(item => item.content.id === content.id);
        if (exists) {
            alert('This content is already in the playlist');
            return;
        }

        playlistItems.push({
            content: content,
            duration: content.duration || 10,
            order: playlistItems.length
        });

        renderPlaylistItems();
    }

    function updateItemDuration(index, duration) {
        playlistItems[index].duration = parseInt(duration);
    }

    function removePlaylistItem(index) {
        if (confirm('Remove this item from the playlist?')) {
            playlistItems.splice(index, 1);
            renderPlaylistItems();
        }
    }

    // Playlist item reordering
    function handlePlaylistItemDragStart(e) {
        draggedElement = e.target;
        e.target.style.opacity = '0.5';
    }

    function handlePlaylistItemDragOver(e) {
        e.preventDefault();
        const target = e.target.closest('.playlist-item');
        if (target && target !== draggedElement) {
            target.style.borderTop = '3px solid #667eea';
        }
    }

    function handlePlaylistItemDrop(e) {
        e.preventDefault();
        const target = e.target.closest('.playlist-item');

        if (target && target !== draggedElement) {
            const fromIndex = parseInt(draggedElement.dataset.index);
            const toIndex = parseInt(target.dataset.index);

            const [movedItem] = playlistItems.splice(fromIndex, 1);
            playlistItems.splice(toIndex, 0, movedItem);

            renderPlaylistItems();
        }

        // Clear border
        document.querySelectorAll('.playlist-item').forEach(item => {
            item.style.borderTop = '';
        });
    }

    function handlePlaylistItemDragEnd(e) {
        e.target.style.opacity = '';
        draggedElement = null;
    }

    async function savePlaylist() {
        if (!currentPlaylist) return;

        try {
            // Delete all existing items
            for (const item of currentPlaylist.items || []) {
                await fetch(`/admin/playlist/${currentPlaylist.id}/item/${item.id}/delete`, {
                    method: 'POST'
                });
            }

            // Add new items with order and duration
            for (let i = 0; i < playlistItems.length; i++) {
                const item = playlistItems[i];
                await fetch(`/admin/playlist/${currentPlaylist.id}/add_content`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content_id: item.content.id,
                        duration: item.duration,
                        order: i
                    })
                });
            }

            alert('Playlist saved successfully!');
            window.location.reload();
        } catch (error) {
            console.error('Error saving playlist:', error);
            alert('Failed to save playlist');
        }
    }

    // Modal functions
    function showCreatePlaylistModal() {
        document.getElementById('createPlaylistModal').style.display = 'flex';
    }

    function hideCreatePlaylistModal() {
        document.getElementById('createPlaylistModal').style.display = 'none';
        document.getElementById('newPlaylistName').value = '';
        document.getElementById('newPlaylistDescription').value = '';
    }

    async function createPlaylist() {
        const name = document.getElementById('newPlaylistName').value.trim();
        if (!name) {
            alert('Please enter a playlist name');
            return;
        }

        try {
            const response = await fetch('/admin/playlist/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: name,
                    description: document.getElementById('newPlaylistDescription').value.trim()
                })
            });

            if (response.ok) {
                window.location.reload();
            } else {
                alert('Failed to create playlist');
            }
        } catch (error) {
            console.error('Error creating playlist:', error);
            alert('Failed to create playlist');
        }
    }

    async function deletePlaylist(playlistId, playlistName) {
        if (!confirm(`Delete playlist "${playlistName}"?`)) {
            return;
        }

        try {
            const response = await fetch(`/admin/playlist/${playlistId}/delete`, {
                method: 'POST'
            });

            if (response.ok) {
                window.location.reload();
            } else {
                alert('Failed to delete playlist');
            }
        } catch (error) {
            console.error('Error deleting playlist:', error);
            alert('Failed to delete playlist');
        }
    }
</script>
{% endblock %}
