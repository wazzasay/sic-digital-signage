{% extends "base.html" %}

{% block title %}Playlists - Digital Signage Manager{% endblock %}

{% block content %}
<div class="card">
    <h2>Create Playlist</h2>
    <form id="createPlaylistForm">
        <div class="form-group">
            <label for="name">Playlist Name</label>
            <input type="text" id="name" name="name" required>
        </div>

        <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" name="description" rows="3"></textarea>
        </div>

        <button type="submit" class="btn btn-primary">Create Playlist</button>
    </form>

    <div id="createStatus" style="margin-top: 1rem;"></div>
</div>

<div class="card">
    <h2>Playlists</h2>
    {% if playlists %}
    {% for playlist in playlists %}
    <div class="card" style="background: #f8f9fa; margin-bottom: 1rem;">
        <h3>{{ playlist.name }}</h3>
        <p>{{ playlist.description or 'No description' }}</p>

        <div style="margin-top: 1rem;">
            <h4>Content Items ({{ playlist.items|length }})</h4>
            {% if playlist.items %}
            <table style="margin-top: 0.5rem;">
                <thead>
                    <tr>
                        <th>Order</th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Duration</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in playlist.items %}
                    <tr>
                        <td>{{ item.order }}</td>
                        <td>{{ item.content.name }}</td>
                        <td>{{ item.content.content_type|capitalize }}</td>
                        <td>{{ item.content.duration }}s</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p style="color: #666; padding: 1rem 0;">No content in this playlist yet</p>
            {% endif %}
        </div>

        <div style="margin-top: 1rem;">
            <select id="content-select-{{ playlist.id }}">
                <option value="">Select content to add</option>
                {% for content in content_list %}
                <option value="{{ content.id }}">{{ content.name }} ({{ content.content_type }})</option>
                {% endfor %}
            </select>
            <button class="btn btn-success" onclick="addContentToPlaylist({{ playlist.id }})" style="margin-left: 0.5rem;">
                Add Content
            </button>
            <button class="btn btn-danger" onclick="deletePlaylist({{ playlist.id }})" style="margin-left: 0.5rem;">
                Delete Playlist
            </button>
        </div>
    </div>
    {% endfor %}
    {% else %}
    <p style="color: #666; text-align: center; padding: 2rem;">No playlists created yet</p>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('createPlaylistForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(e.target);
        const data = {
            name: formData.get('name'),
            description: formData.get('description')
        };

        const statusDiv = document.getElementById('createStatus');

        try {
            const response = await fetch('/admin/playlist/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok) {
                statusDiv.innerHTML = '<div class="alert alert-success">Playlist created successfully!</div>';
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                statusDiv.innerHTML = `<div class="alert alert-error">${result.error}</div>`;
            }
        } catch (error) {
            statusDiv.innerHTML = '<div class="alert alert-error">Failed to create playlist</div>';
        }
    });

    async function addContentToPlaylist(playlistId) {
        const select = document.getElementById(`content-select-${playlistId}`);
        const contentId = select.value;

        if (!contentId) {
            alert('Please select content to add');
            return;
        }

        try {
            const response = await fetch(`/admin/playlist/${playlistId}/add_content`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content_id: contentId })
            });

            if (response.ok) {
                alert('Content added to playlist');
                window.location.reload();
            } else {
                alert('Failed to add content');
            }
        } catch (error) {
            alert('Failed to add content');
        }
    }

    async function deletePlaylist(playlistId) {
        if (!confirm('Are you sure you want to delete this playlist?')) {
            return;
        }

        try {
            const response = await fetch(`/admin/playlist/${playlistId}/delete`, {
                method: 'POST'
            });

            if (response.ok) {
                alert('Playlist deleted');
                window.location.reload();
            } else {
                alert('Failed to delete playlist');
            }
        } catch (error) {
            alert('Failed to delete playlist');
        }
    }
</script>
{% endblock %}
